{% extends "base.html" %} {% block title %}Question Bank - Add Question{% endblock %} {% block head %}
<style>
    #latex-preview {
        border: 1px solid #ccc;
        padding: 15px;
        margin-top: 10px;
        min-height: 50px;
        background-color: #f9f9f9;
        text-align: center;
    }
    
    .tag-badge {
        margin: 5px;
        padding: 5px 10px;
        display: inline-block;
        cursor: pointer;
        background-color: #6c757d;
        color: white;
        border-radius: 4px;
    }
    
    .tag-badge:hover {
        opacity: 0.8;
    }
    
    .selected-tag {
        background-color: #0d6efd;
        color: white;
    }
    
    .tag-selection-area {
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
        min-height: 100px;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .attachments-area {
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    
    .attachment-item {
        margin-bottom: 10px;
        padding: 8px;
        border: 1px solid #eee;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    
    .url-attachments-container {
        margin-top: 15px;
    }
    
    .example-code {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        position: relative;
        margin-bottom: 15px;
    }
    
    .copy-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        padding: 3px 8px;
        font-size: 12px;
    }
    
    .copy-btn:hover {
        background-color: #e9ecef;
    }
    
    .preview-message {
        padding: 20px;
        color: #6c757d;
    }
    
    .compile-error {
        color: #dc3545;
        text-align: left;
        padding: 10px;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        margin-top: 10px;
    }
    
    .preview-spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #09f;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .page-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loader-content {
        text-align: center;
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .page-loader-spinner {
        border: 6px solid rgba(0, 0, 0, 0.1);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border-left-color: #09f;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
    }
</style>
{% endblock %} {% block content %}
<!-- Page Loader -->
<div id="page-loader" class="page-loader">
    <div class="loader-content">
        <div class="page-loader-spinner"></div>
        <div>Loading form...</div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <h1>Add New Question</h1>
        <p class="text-muted">Use LaTeX syntax for mathematical expressions. TikZ and CircuiTikZ diagrams are supported.</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Question Form</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('add_question') }}" id="question-form" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}

                    <div class="mb-3">
                        <label for="name" class="form-label">{{ form.name.label }}</label> {{ form.name(class="form-control", id="name", placeholder="Enter a descriptive name for the question...") }} {% if form.name.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.name.errors %} {{ error }} {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="content" class="form-label">{{ form.content.label }}</label> {{ form.content(class="form-control", id="latex-input", rows=5, placeholder="Enter LaTeX content...") }} {% if form.content.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.content.errors %} {{ error }} {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Preview</label>
                        <button type="button" id="compile-button" class="btn btn-primary btn-sm">Compile Preview</button>
                        <div id="latex-preview">
                            <div id="preview-placeholder" class="preview-message">Press compile preview to preview SVG</div>
                            <div id="preview-spinner" class="preview-spinner" style="display: none;"></div>
                            <div id="math-preview" style="display: none;"></div>
                            <div id="compile-error" class="compile-error" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="rating" class="form-label">{{ form.rating.label }}</label> {{ form.rating(class="form-control", id="rating", min=1.0, max=10.0, step=0.1) }} {% if form.rating.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.rating.errors %} {{ error }} {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Select Tags</label>
                        <div class="tag-selection-area">
                            {% if all_tags %} 
                                {% for tag in all_tags %}
                                <span class="badge tag-badge" data-tag="{{ tag.id }}" onclick="toggleTag(this)">{{ tag.display_name }}</span> 
                                {% endfor %} 
                            {% else %}
                                <p class="text-muted">No tags available. Please add tags in the Question Bank page first.</p>
                            {% endif %}
                        </div>
                        <div id="selected-tags-container">
                            <!-- Hidden inputs for selected tags will be added here by JavaScript -->
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Add Attachments</label>
                        <div class="attachments-area">
                            <div class="mb-3">
                                <label for="attachment_file" class="form-label">Upload Files</label>
                                <input type="file" name="attachment_file" multiple class="form-control" id="attachment_file" accept=".pdf,.png,.jpg,.jpeg,.webm,.mp4,.docx,.xlsx,.pptx">
                                <div class="form-text">
                                    <p>Select up to 4 files to upload (max 100MB total):</p>
                                    <ul class="small text-muted">
                                        <li>At most 1 PDF file</li>
                                        <li>At most 1 video file (webm or mp4)</li>
                                        <li>At most 1 image file (png, jpg, or jpeg)</li>
                                        <li>Any number of document files (docx, xlsx, pptx) up to the 4-file limit</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Add URLs</label>
                                <div id="url-attachments-container" class="url-attachments-container">
                                    <div class="input-group mb-2">
                                        <input type="url" name="attachment_url" class="form-control" placeholder="https://example.com/resource">
                                        <button type="button" class="btn btn-outline-secondary" onclick="addUrlField()">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.submit(class="btn btn-primary") }}
                        <a href="{{ url_for('questionbank') }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="accordion" id="examplesAccordion">
            <!-- LaTeX Examples -->
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="headingLatexExamples">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLatexExamples" aria-expanded="false" aria-controls="collapseLatexExamples">
                        LaTeX Examples
                    </button>
                </h2>
                <div id="collapseLatexExamples" class="accordion-collapse collapse" aria-labelledby="headingLatexExamples" data-bs-parent="#examplesAccordion">
                    <div class="accordion-body">
                        <h6>Mathematical Formula</h6>
                        <div class="example-code">
                            <button class="copy-btn" onclick="copyExample(this)">Copy</button>
<pre>\documentclass{exam}
\usepackage{amsmath}
\usepackage[active,tightpage]{preview}
\PreviewEnvironment{questions}

\begin{document}

\begin{questions}
\question
$x = \frac{-b \pm \sqrt{b^2 - 4ac}}{2a}$
\end{questions}

\end{document}</pre>
                        </div>

                        <h6>Multiple Choice Question</h6>
                        <div class="example-code">
                            <button class="copy-btn" onclick="copyExample(this)">Copy</button>
<pre>\documentclass{exam}
\usepackage{amsmath}
\usepackage{enumitem}
\usepackage[active,tightpage]{preview}
\PreviewEnvironment{questions}

\begin{document}

\begin{questions}
\question
Which of the following is the solution to $x^2 + 6x + 9 = 0$?

\begin{enumerate}[label=\Alph*.]
    \item $x = 3$
    \item $x = -3$
    \item $x = \pm 3$
    \item $x = -3$ (with multiplicity 2)
\end{enumerate}

\textbf{Answer:} D
\end{questions}

\end{document}</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- TikZ & CircuiTikZ -->
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="headingTikZ">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTikZ" aria-expanded="false" aria-controls="collapseTikZ">
                        TikZ & CircuiTikZ Examples
                    </button>
                </h2>
                <div id="collapseTikZ" class="accordion-collapse collapse" aria-labelledby="headingTikZ" data-bs-parent="#examplesAccordion">
                    <div class="accordion-body">
                        <h6>TikZ Example</h6>
                        <div class="example-code">
                            <button class="copy-btn" onclick="copyExample(this)">Copy</button>
<pre>\documentclass{exam}
\usepackage{tikz}
\usepackage[active,tightpage]{preview}
\PreviewEnvironment{tikzpicture}

\begin{document}

\begin{tikzpicture}
\draw (0,0) circle (1cm);
\fill (0,0) circle (2pt);
\draw[->] (0,0) -- (1,0);
\end{tikzpicture}

\end{document}</pre>
                        </div>

                        <h6>CircuiTikZ Example</h6>
                        <div class="example-code">
                            <button class="copy-btn" onclick="copyExample(this)">Copy</button>
<pre>\documentclass{exam}
\usepackage{circuitikz}
\usepackage[active,tightpage]{preview}
\PreviewEnvironment{circuitikz}

\begin{document}

\begin{circuitikz}
\draw (0,0) to[R=$R_1$] (2,0)
      to[V=$V_1$] (2,2)
      to[R=$R_2$] (0,2)
      to[C=$C_1$] (0,0);
\end{circuitikz}

\end{document}</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Physics Example -->
            <div class="accordion-item mb-2">
                <h2 class="accordion-header" id="headingPhysics">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePhysics" aria-expanded="false" aria-controls="collapsePhysics">
                        Physics MCQ Example
                    </button>
                </h2>
                <div id="collapsePhysics" class="accordion-collapse collapse" aria-labelledby="headingPhysics" data-bs-parent="#examplesAccordion">
                    <div class="accordion-body">
                        <div class="example-code">
                            <button class="copy-btn" onclick="copyExample(this)">Copy</button>
<pre>\documentclass{exam}
\usepackage{tikz}
\usepackage{amsmath}
\usepackage{enumitem}
\usepackage[active,tightpage]{preview}
\PreviewEnvironment{questions}

\begin{document}

\begin{questions}
\question
A light ray travels from air into a glass block as shown. Which of the following best describes the behavior of the light as it enters the glass?

\begin{center}
\begin{tikzpicture}[scale=1.2]
    \node at (2, 2.3) {Air};
    \node at (2, 0.3) {Glass};
    \draw[fill=blue!10] (0,0) rectangle (4,1.5);
    \draw[dashed] (2,2.5) -- (2,-0.5);
    \draw[->, thick] (0.5,2) -- (2,1);
    \draw[->, thick] (2,1) -- (3.2,0.4);
    \draw (2,1) +(50:0.5) arc[start angle=50,end angle=90,radius=0.5];
    \node at (2.4,1.4) {\small $\theta_1$};
    \draw (2,1) +(270:0.5) arc[start angle=270,end angle=305,radius=0.5];
    \node at (2.3,0.5) {\small $\theta_2$};
    \node at (1.2,2.1) {Incident ray};
    \node at (3.5,0.3) {Refracted ray};
\end{tikzpicture}
\end{center}

\begin{enumerate}[label=\Alph*.]
    \item The light speeds up and bends away from the normal.  
    \item The light slows down and bends toward the normal.  
    \item The light slows down and bends away from the normal.  
    \item The light continues in a straight line.
\end{enumerate}

\textbf{Answer:} B
\end{questions}

\end{document}</pre>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Math Short Answer with Parts/Subparts -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingMathParts">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMathParts" aria-expanded="false" aria-controls="collapseMathParts">
                        Math Short Answer with Parts/Subparts
                    </button>
                </h2>
                <div id="collapseMathParts" class="accordion-collapse collapse" aria-labelledby="headingMathParts" data-bs-parent="#examplesAccordion">
                    <div class="accordion-body">
                        <div class="example-code">
                            <button class="copy-btn" onclick="copyExample(this)">Copy</button>
<pre>\documentclass{exam}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage[active,tightpage]{preview}
\PreviewEnvironment{questions}

\begin{document}

\begin{questions}
\question[10] For the function $f(x) = 3x^2 - 4x + 2$, answer the following:
\begin{parts}
    \part[3] Find all critical points of the function.
    \begin{solution}
        To find critical points, we set $f'(x) = 0$:
        \begin{align}
            f'(x) &= 6x - 4\\
            6x - 4 &= 0\\
            6x &= 4\\
            x &= \frac{2}{3}
        \end{align}
        
        So there is one critical point at $x = \frac{2}{3}$.
    \end{solution}
    
    \part[3] Determine whether each critical point is a local maximum, local minimum, or neither.
    \begin{solution}
        We can use the second derivative test:
        \begin{align}
            f''(x) = 6
        \end{align}
        
        Since $f''(\frac{2}{3}) = 6 > 0$, the critical point is a local minimum.
    \end{solution}
    
    \part[4] Calculate the following:
    \begin{subparts}
        \subpart[2] The value of the function at the critical point.
        \begin{solution}
            \begin{align}
                f\left(\frac{2}{3}\right) &= 3\left(\frac{2}{3}\right)^2 - 4\left(\frac{2}{3}\right) + 2\\
                &= 3 \cdot \frac{4}{9} - 4 \cdot \frac{2}{3} + 2\\
                &= \frac{4}{3} - \frac{8}{3} + 2\\
                &= \frac{4 - 8 + 6}{3}\\
                &= \frac{2}{3}
            \end{align}
            
            The value of the function at the critical point is $f\left(\frac{2}{3}\right) = \frac{2}{3}$.
        \end{solution}
        
        \subpart[2] The range of the function.
        \begin{solution}
            Since $f(x) = 3x^2 - 4x + 2$ has a leading coefficient of 3 (positive), the parabola opens upward.
            The minimum value is $f\left(\frac{2}{3}\right) = \frac{2}{3}$.
            Therefore, the range of $f(x)$ is $\left[\frac{2}{3}, \infty\right)$.
        \end{solution}
    \end{subparts}
\end{parts}
\end{questions}

\end{document}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    // Copy example code function - defined globally
    function copyExample(button) {
        const codeBlock = button.nextElementSibling;
        const textToCopy = codeBlock.textContent;
        
        // Try to use the clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    showCopiedMessage(button);
                })
                .catch(err => {
                    console.error('Could not copy text with clipboard API: ', err);
                    fallbackCopyText(textToCopy, button);
                });
        } else {
            // Fallback for browsers without clipboard API
            fallbackCopyText(textToCopy, button);
        }
    }
    
    // Fallback copy method using a temporary textarea element
    function fallbackCopyText(text, button) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';  // Prevent scrolling to the element
        textarea.style.opacity = '0';       // Make it invisible
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showCopiedMessage(button);
            } else {
                alert('Failed to copy text. Please try manually selecting and copying the text.');
            }
        } catch (err) {
            console.error('Fallback copy method failed: ', err);
            alert('Failed to copy text. Please try manually selecting and copying the text.');
        } finally {
            document.body.removeChild(textarea);
        }
    }
    
    // Show the "Copied!" message
    function showCopiedMessage(button) {
        const originalText = button.textContent;
        button.textContent = "Copied!";
        setTimeout(() => {
            button.textContent = originalText;
        }, 1500);
    }

    // Tag selection functionality - GLOBAL SCOPE
    function toggleTag(element) {
        element.classList.toggle('selected-tag');
        updateSelectedTags();
    }

    function updateSelectedTags() {
        const container = document.getElementById('selected-tags-container');
        container.innerHTML = '';

        const selectedTags = document.querySelectorAll('.tag-badge.selected-tag');
        selectedTags.forEach(tag => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'selected_tags';
            input.value = tag.dataset.tag;
            container.appendChild(input);
        });
    }

    // URL attachment fields - GLOBAL SCOPE
    function addUrlField() {
        const container = document.getElementById('url-attachments-container');
        const newField = document.createElement('div');
        newField.className = 'input-group mb-2';
        newField.innerHTML = `
            <input type="url" name="attachment_url" class="form-control" placeholder="https://example.com/resource">
            <button type="button" class="btn btn-outline-danger" onclick="removeUrlField(this)">-</button>
        `;
        container.appendChild(newField);
    }

    function removeUrlField(button) {
        const fieldDiv = button.parentNode;
        fieldDiv.parentNode.removeChild(fieldDiv);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Hide the page loader when DOM is loaded
        document.getElementById('page-loader').style.display = 'none';
        
        const latexInput = document.getElementById('latex-input');
        const mathPreview = document.getElementById('math-preview');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        const compileButton = document.getElementById('compile-button');
        const compileError = document.getElementById('compile-error');
        const previewSpinner = document.getElementById('preview-spinner');

        compileButton.addEventListener('click', function() {
            const latex = latexInput.value;
            if (!latex.trim()) {
                previewPlaceholder.style.display = 'block';
                mathPreview.style.display = 'none';
                compileError.style.display = 'none';
                previewSpinner.style.display = 'none';
                return;
            }

            // Show spinner, hide other elements
            previewPlaceholder.style.display = 'none';
            mathPreview.style.display = 'none';
            compileError.style.display = 'none';
            previewSpinner.style.display = 'block';
            
            // Send to server to compile - for ALL LaTeX content
            fetch('/api/compile-latex', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({latex: latex})
            })
            .then(response => response.json())
            .then(data => {
                // Hide spinner
                previewSpinner.style.display = 'none';
                
                if (data.success) {
                    mathPreview.innerHTML = '<img src="' + data.svg + '" class="img-fluid" alt="LaTeX Preview">';
                    mathPreview.style.display = 'block';
                } else {
                    compileError.textContent = 'Compilation Error: ' + data.error;
                    compileError.style.display = 'block';
                }
            })
            .catch(error => {
                // Hide spinner
                previewSpinner.style.display = 'none';
                
                compileError.textContent = 'Server Error: ' + error.message;
                compileError.style.display = 'block';
            });
        });
    });
</script>
{% endblock %}